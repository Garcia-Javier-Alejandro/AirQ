<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AirQ ‚Äì Monitor de Calidad del Aire</title>
  
  <link rel="stylesheet" href="/output.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mqtt@5.3.0/dist/mqtt.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-green-50 min-h-screen">
  <div class="container mx-auto px-4 py-6 max-w-7xl">
    <!-- Header -->
    <header class="mb-8">
      <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-600 to-green-600 bg-clip-text text-transparent">
              AirQ Monitor
            </h1>
            <p class="text-gray-600 mt-1 text-sm md:text-base">
              Monitoreo de calidad del aire en tiempo real
            </p>
          </div>
          <div id="status" class="flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-lg border border-gray-200">
            <div class="animate-pulse h-2 w-2 bg-blue-500 rounded-full"></div>
            <span class="text-sm font-medium text-gray-700">Inicializando...</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Time Range Controls -->
    <div class="bg-white rounded-xl shadow-md p-4 mb-6 border border-gray-100">
      <div class="flex flex-col md:flex-row md:items-center gap-4">
        <label for="timeRangeSelect" class="text-sm font-semibold text-gray-700">
          Rango de Tiempo:
        </label>
        <select 
          id="timeRangeSelect" 
          onchange="handleTimeRangeChange()"
          class="flex-1 md:flex-none px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
        >
          <option value="10min">√öltimos 10 minutos (Tiempo Real)</option>
          <option value="all">Desde el inicio (Hist√≥rico)</option>
          <option value="custom">Rango personalizado</option>
        </select>
        
        <div class="flex-1 flex flex-wrap items-center gap-2" id="customDateRange" style="display: none;">
          <input 
            type="date" 
            id="startDate"
            class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <span class="text-gray-500 text-sm font-medium">hasta</span>
          <input 
            type="date" 
            id="endDate"
            class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <button 
            onclick="loadCustomRange()"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 active:bg-blue-800 transition shadow-sm"
          >
            Aplicar
          </button>
        </div>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 gap-6">
      <!-- AQ Index Chart -->
      <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-100">
        <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
          <span class="h-8 w-8 bg-gradient-to-br from-green-400 to-green-600 rounded-lg flex items-center justify-center text-white text-sm">
            AQ
          </span>
          √çndice de Calidad del Aire
        </h2>
        <div class="relative h-64 md:h-80">
          <canvas id="aqChart"></canvas>
        </div>
        <div class="mt-4 flex flex-wrap gap-3 text-xs md:text-sm">
          <div class="flex items-center gap-2">
            <div class="h-3 w-3 rounded-full bg-aq-good"></div>
            <span class="text-gray-600"><strong>0-20:</strong> Buena</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="h-3 w-3 rounded-full bg-aq-fair"></div>
            <span class="text-gray-600"><strong>20-60:</strong> Moderada</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="h-3 w-3 rounded-full bg-aq-poor"></div>
            <span class="text-gray-600"><strong>60+:</strong> Mala</span>
          </div>
        </div>
      </div>

      <!-- Temperature & Humidity Chart -->
      <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-100">
        <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
          <span class="h-8 w-8 bg-gradient-to-br from-red-400 to-blue-400 rounded-lg flex items-center justify-center text-white text-sm">
            ¬∞C
          </span>
          Temperatura y Humedad
        </h2>
        <div class="relative h-64 md:h-80">
          <canvas id="trhChart"></canvas>
        </div>
      </div>

      <!-- TVOC & eCO2 Chart -->
      <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-100">
        <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
          <span class="h-8 w-8 bg-gradient-to-br from-purple-400 to-orange-400 rounded-lg flex items-center justify-center text-white text-sm">
            CO
          </span>
          Compuestos Org√°nicos y CO‚ÇÇ
        </h2>
        <div class="relative h-64 md:h-80">
          <canvas id="gasChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Manual Data Input (Collapsible) -->
    <details class="mt-8 bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
      <summary class="px-6 py-4 cursor-pointer font-semibold text-blue-600 hover:bg-blue-50 transition select-none">
        Entrada manual de datos (para datos sin conexi√≥n)
      </summary>
      <div class="px-6 pb-6 pt-2">
        <textarea 
          id="input" 
          placeholder="Pegar salida serial del ESP8266 aqu√≠ (un JSON por l√≠nea)"
          class="w-full h-48 font-mono text-xs p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y scrollbar-thin"
        ></textarea>
        <button 
          onclick="loadManualData()"
          class="mt-3 px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 active:bg-blue-800 transition shadow-sm"
        >
          Cargar datos pegados
        </button>
      </div>
    </details>
  </div>

  <script>
    // Configuration
    const MQTT_BROKER = "wss://1f1fff2e23204fa08aef0663add440bc.s1.eu.hivemq.cloud:8884/mqtt";
    const MQTT_TOPIC = "airq/airq-d1mini-01";
    const MQTT_USERNAME = "AirQ-01";
    const MQTT_PASSWORD = "AirQ-01-pass";
    const HISTORY_SIZE = 120;
    const UPDATE_INTERVAL = 5000;

    let samples = [];
    let historicalData = [];
    let displayData = [];
    let charts = [];
    let mqttClient = null;
    let updateInterval = null;
    let currentTimeRange = "10min";

    function formatTimeOfDay(tsMs) {
      const date = new Date(tsMs);
      return date.toLocaleTimeString('es-ES', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false 
      });
    }

    function handleTimeRangeChange() {
      const range = document.getElementById("timeRangeSelect").value;
      currentTimeRange = range;

      if (range === "custom") {
        document.getElementById("customDateRange").style.display = "flex";
      } else {
        document.getElementById("customDateRange").style.display = "none";
        if (range === "10min") {
          displayData = [...samples];
          renderCharts();
        } else if (range === "all") {
          loadHistoricalData();
        }
      }
    }

    async function loadHistoricalData() {
      try {
        updateStatus("‚è≥ Cargando datos hist√≥ricos...", "text-blue-600");
        const response = await fetch('/api/history?days=30');
        const result = await response.json();

        if (result.success && result.data && result.data.length > 0) {
          historicalData = result.data.map(row => ({
            ts_ms: new Date(row.timestamp).getTime(),
            device_id: row.device_id,
            t_c: row.temp_c_avg,
            rh: row.rh_avg,
            tvoc_ppb: row.tvoc_ppb_avg,
            eco2_ppm: row.eco2_ppm_avg,
            aq_index: row.aq_index_avg,
            is_historical: true
          }));

          displayData = [...historicalData];
          renderCharts();
          updateStatus(`‚úì ${historicalData.length} registros hist√≥ricos cargados`, "text-green-600");
        } else {
          updateStatus("‚ö†Ô∏è No hay datos hist√≥ricos disponibles a√∫n", "text-amber-600");
        }
      } catch (error) {
        console.error('Failed to load historical data:', error);
        updateStatus("‚ùå Error al cargar datos hist√≥ricos", "text-red-600");
      }
    }

    async function loadCustomRange() {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      if (!startDate || !endDate) {
        alert("Por favor selecciona ambas fechas");
        return;
      }

      const start = new Date(startDate).getTime();
      const end = new Date(endDate).getTime() + 24 * 60 * 60 * 1000;

      displayData = historicalData.filter(d => d.ts_ms >= start && d.ts_ms <= end);
      renderCharts();
      updateStatus(`‚úì ${displayData.length} registros en rango seleccionado`, "text-green-600");
    }

    function loadManualData() {
      const lines = document.getElementById("input").value
        .split("\n")
        .map(l => l.trim())
        .filter(l => l.startsWith("{"));

      samples = lines.map(l => JSON.parse(l));
      displayData = [...samples];
      renderCharts();
      updateStatus(`‚úì ${samples.length} lecturas cargadas desde entrada manual`, "text-green-600");
    }

    function updateStatus(text, colorClass = "text-gray-700") {
      const statusEl = document.getElementById("status");
      statusEl.innerHTML = `
        <div class="animate-pulse h-2 w-2 ${colorClass.replace('text', 'bg')} rounded-full"></div>
        <span class="text-sm font-medium ${colorClass}">${text}</span>
      `;
    }

    function makeChart(canvasId, chartData, chartOptions) {
      const ctx = document.getElementById(canvasId).getContext("2d");
      return new Chart(ctx, {
        type: "line",
        data: chartData,
        options: chartOptions
      });
    }

    function renderCharts() {
      charts.forEach(c => c.destroy());
      charts = [];

      if (displayData.length === 0) return;

      const labels = displayData.map(s => formatTimeOfDay(s.ts_ms));
      const temp = displayData.map(s => s.t_c);
      const rh = displayData.map(s => s.rh);
      const tvoc = displayData.map(s => s.tvoc_ppb);
      const eco2 = displayData.map(s => s.eco2_ppm);
      const aq = displayData.map(s => s.aq_index);

      // Common chart options
      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          tooltip: {
            enabled: true,
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: '#666',
            borderWidth: 1,
            padding: 12,
            displayColors: true,
            callbacks: {
              title: function(context) {
                return 'Hora: ' + context[0].label;
              }
            }
          },
          legend: {
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 15,
              font: {
                size: 12,
                family: 'system-ui'
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              maxTicksLimit: 8, // Fewer labels on x-axis
              autoSkip: true,
              font: {
                size: 11
              }
            },
            grid: {
              display: false
            }
          }
        }
      };

      // ==================== AQ INDEX CHART ====================
      const aqBandsPlugin = {
        id: "aqBands",
        beforeDraw(chart) {
          const { ctx, chartArea, scales } = chart;
          if (!chartArea) return;
          const y = scales.y;
          const xLeft = chartArea.left;
          const xRight = chartArea.right;
          
          function fillBand(yMin, yMax, color) {
            const yTop = y.getPixelForValue(yMax);
            const yBottom = y.getPixelForValue(yMin);
            ctx.save();
            ctx.fillStyle = color;
            ctx.fillRect(xLeft, yTop, xRight - xLeft, yBottom - yTop);
            ctx.restore();
          }
          
          fillBand(0, 20,  "rgba(16, 185, 129, 0.2)");  // Green - more visible
          fillBand(20, 60, "rgba(245, 158, 11, 0.2)");  // Amber
          fillBand(60, 100,"rgba(239, 68, 68, 0.2)");   // Red
        }
      };

      charts.push(makeChart(
        "aqChart",
        {
          labels: labels,
          datasets: [{
            label: "√çndice AQ",
            data: aq,
            borderColor: "#10b981",
            backgroundColor: "rgba(16, 185, 129, 0.1)",
            borderWidth: 3,
            pointRadius: 0,
            pointHoverRadius: 5,
            pointHoverBackgroundColor: "#10b981",
            tension: 0.4,
            fill: true
          }]
        },
        {
          ...commonOptions,
          scales: {
            ...commonOptions.scales,
            y: {
              beginAtZero: true,
              suggestedMax: 100,
              ticks: {
                font: { size: 11 }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          },
          plugins: {
            ...commonOptions.plugins,
            tooltip: {
              ...commonOptions.plugins.tooltip,
              callbacks: {
                title: function(context) {
                  return 'Hora: ' + context[0].label;
                },
                label: function(context) {
                  const val = context.parsed.y;
                  let quality = val < 20 ? 'Buena' : val < 60 ? 'Moderada' : 'Mala';
                  return `AQ: ${val} (${quality})`;
                }
              }
            }
          }
        }
      ));
      charts[0].config.plugins = [aqBandsPlugin];
      charts[0].update();

      // ==================== TEMPERATURE + HUMIDITY ====================
      charts.push(makeChart(
        "trhChart",
        {
          labels: labels,
          datasets: [
            {
              label: "Temperatura (¬∞C)",
              data: temp,
              borderColor: "#ef4444",
              backgroundColor: "rgba(239, 68, 68, 0.1)",
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5,
              tension: 0.4,
              yAxisID: "yTemp",
              fill: true
            },
            {
              label: "Humedad (%)",
              data: rh,
              borderColor: "#3b82f6",
              backgroundColor: "rgba(59, 130, 246, 0.1)",
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5,
              tension: 0.4,
              yAxisID: "yRh",
              fill: true
            }
          ]
        },
        {
          ...commonOptions,
          scales: {
            ...commonOptions.scales,
            yTemp: {
              type: "linear",
              position: "left",
              ticks: { font: { size: 11 } },
              grid: { color: 'rgba(239, 68, 68, 0.1)' }
            },
            yRh: {
              type: "linear",
              position: "right",
              ticks: { font: { size: 11 } },
              grid: { drawOnChartArea: false }
            }
          }
        }
      ));

      // ==================== TVOC + eCO‚ÇÇ ====================
      charts.push(makeChart(
        "gasChart",
        {
          labels: labels,
          datasets: [
            {
              label: "TVOC (ppb)",
              data: tvoc,
              borderColor: "#8b5cf6",
              backgroundColor: "rgba(139, 92, 246, 0.1)",
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5,
              tension: 0.4,
              yAxisID: "yTvoc",
              fill: true
            },
            {
              label: "eCO‚ÇÇ (ppm)",
              data: eco2,
              borderColor: "#f59e0b",
              backgroundColor: "rgba(245, 158, 11, 0.1)",
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 5,
              tension: 0.4,
              yAxisID: "yEco2",
              fill: true
            }
          ]
        },
        {
          ...commonOptions,
          scales: {
            ...commonOptions.scales,
            yTvoc: {
              type: "linear",
              position: "left",
              ticks: { font: { size: 11 } },
              grid: { color: 'rgba(139, 92, 246, 0.1)' }
            },
            yEco2: {
              type: "linear",
              position: "right",
              ticks: { font: { size: 11 } },
              grid: { drawOnChartArea: false }
            }
          }
        }
      ));
    }

    function connectMQTT() {
      updateStatus("üîÑ Conectando a HiveMQ...", "text-blue-600");
      
      mqttClient = mqtt.connect(MQTT_BROKER, {
        clientId: 'airq-dashboard-' + Math.random().toString(16).substr(2, 8),
        clean: true,
        reconnectPeriod: 1000,
        connectTimeout: 5000,
        username: MQTT_USERNAME,
        password: MQTT_PASSWORD
      });

      mqttClient.on('connect', () => {
        console.log('Connected to HiveMQ');
        updateStatus("‚úì Conectado a HiveMQ", "text-green-600");
        mqttClient.subscribe(MQTT_TOPIC, (err) => {
          if (err) {
            console.error('Subscribe error:', err);
            updateStatus("‚ùå Error de suscripci√≥n", "text-red-600");
          } else {
            console.log('Subscribed to', MQTT_TOPIC);
            updateStatus("‚úì Escuchando datos...", "text-green-600");
          }
        });
      });

      mqttClient.on('message', (topic, message) => {
        try {
          const json = JSON.parse(message.toString());
          samples.push(json);
          
          if (samples.length > HISTORY_SIZE) {
            samples.shift();
          }
          
          if (currentTimeRange === "10min") {
            displayData = [...samples];
          }
          
          const time = new Date().toLocaleTimeString('es-ES');
          updateStatus(`‚úì ${samples.length} lecturas (√∫ltima: ${time})`, "text-green-600");
        } catch (e) {
          console.error('Parse error:', e);
        }
      });

      mqttClient.on('error', (err) => {
        console.error('MQTT error:', err);
        updateStatus("‚ö†Ô∏è Error de conexi√≥n - reintentando...", "text-amber-600");
      });

      mqttClient.on('offline', () => {
        updateStatus("‚ö†Ô∏è Desconectado - reconectando...", "text-amber-600");
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      connectMQTT();
      displayData = [...samples];
      
      updateInterval = setInterval(() => {
        if (currentTimeRange === "10min" && samples.length > 0) {
          renderCharts();
        }
      }, UPDATE_INTERVAL);
    });

    window.addEventListener('beforeunload', () => {
      if (updateInterval) clearInterval(updateInterval);
      if (mqttClient) mqttClient.end();
    });
  </script>
</body>
</html>
